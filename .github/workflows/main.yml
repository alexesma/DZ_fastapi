#main.yml
name: Main DragonZap Workflow
# –ü–µ—Ä–µ—á–µ–Ω—å —Å–æ–±—ã—Ç–∏–π-—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è workflow
on:
  # –°–æ–±—ã—Ç–∏–µ push –≤–æ–∑–Ω–∏–∫–∞–µ—Ç,
  # –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä GitHub
  push:
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –≤–µ—Ç–∫–µ main
    branches:
      - main
# –ü–µ—Ä–µ—á–µ–Ω—å –∑–∞–¥–∞—á
jobs:
  tests:
    # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql+asyncpg://testuser:testpassword@127.0.0.1:5432/testdb
      ASYNCPG_DSN: postgresql+asyncpg://testuser:testpassword@127.0.0.1:5432/testdb
      TEST_DATABASE_URL: postgresql+asyncpg://testuser:testpassword@127.0.0.1:5432/testdb

    services:
      db:
        image: postgres:13.10
        # –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã, –∏–º—è –∏ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ,
        # –≤–µ–¥—å —ç—Ç–∞ –±–∞–∑–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≥–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        # –≠—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ postgres
        # –ï—Å–ª–∏ –µ—ë –Ω–µ –±—É–¥–µ—Ç, —Ç–æ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º —Å–µ—Ä–≤–µ—Ä PostgreSQL
        # –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ç–µ—Å—Ç—ã –æ–ø—è—Ç—å —Ä–µ—à–∞—Ç, —á—Ç–æ –±–∞–∑—ã –Ω–µ—Ç, ‚Äî –∏ —É–ø–∞–¥—É—Ç
        options: >-
          --health-cmd="pg_isready -U testuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Check out code
      uses: actions/checkout@v3
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python —Å –ø–æ–º–æ—â—å—é action
    - name: Set up Python
      uses: actions/setup-python@v4
    # –í action setup-python@v4 –ø–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî –≤–µ—Ä—Å–∏—é Python
      with:
        python-version: 3.12

    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-
    # –û–±–Ω–æ–≤–ª—è–µ–º pip, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º flake8 –∏ flake8-isort,
    # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        export PATH="$HOME/.local/bin:$PATH"

    - name: Install dependencies
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        poetry install

    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h 127.0.0.1 -p 5432 -U testuser; do
          echo "Waiting for PostgreSQL...";
          sleep 5;
        done

    - name: Debug Environment Variables
      run: env

    - name: Run database migrations
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        poetry run alembic upgrade head

    # –ó–∞–ø—É—Å–∫–∞–µ–º flake8
    - name: Test with flake8
      # –í—ã–∑—ã–≤–∞–µ–º flake8 –∏ —É–∫–∞–∑—ã–≤–∞–µ–º –µ–º—É,
      # —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ –≤ –ø–∞–ø–∫–µ backend/
      run:  |
        export PATH="$HOME/.local/bin:$PATH"
        poetry run flake8 dz_fastapi/ tests/ check_db.py seed.py

    # –ó–∞–ø—É—Å–∫–∞–µ–º pytest
    - name: Run pytest
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        poetry run pytest

# –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Docker Hub
  build_and_push_to_docker_hub:
    runs-on: ubuntu-latest
    needs: tests  # –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å—Ä–∞–∑—É, –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è tests
    steps:
      - name: Check out the repo
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–±–æ—Ä—â–∏–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ Docker
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker
        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ Docker Hub
        uses: docker/login-action@v2
        # –ü—Ä–∏ –ø–æ–º–æ—â–∏ with –ø–µ—Ä–µ–¥–∞—ë–º –≤ action –ø–∞—Ä–∞–º–µ—Ç—Ä—ã username –∏ password
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push to DockerHub
        # –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–∏–ª–¥ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ –≤ Docker Hub
        uses: docker/build-push-action@v4
        with:
          # –ü–∞—Ä–∞–º–µ—Ç—Ä context: ./backend/ —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω—ã–π Dockerfile
          # –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ .
          context: .
          # –ü–∞—Ä–∞–º–µ—Ç—Ä push: true —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ–±—Ä–∞–∑ –Ω—É–∂–Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–±—Ä–∞—Ç—å,
          # –Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Docker Hub
          push: true
          # –í –ø–∞—Ä–∞–º–µ—Ç—Ä–µ tags –∑–∞–¥–∞—ë—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–≥ –¥–ª—è –æ–±—Ä–∞–∑–∞.
          # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞
          # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–≥ latest, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º
          # –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –≤ docker-compose.yml –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é
          tags: alexesma/dz_fastapi:latest
          no-cache: true

  deploy:
    runs-on: ubuntu-latest
    needs:
      # –î–æ–∂–¥—ë–º—Å—è –±–∏–ª–¥–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ Taski
      - build_and_push_to_docker_hub
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.production.yml –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-—Å–µ—Ä–≤–µ—Ä
    - name: Copy docker-compose.yml via ssh
      uses: appleboy/scp-action@master
    # –ü–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è action appleboy/scp-action:
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "./" # —Å—Ç–∞—Ä—ã–π "infra/dev/docker-compose.dev.yaml"
        target: "/root/DZ_fastapi" # —Å—Ç–∞—Ä—ã–π "/root/DZ_fastapi/infra/dev/"
        strip_components: 0
        overwrite: true
    - name: Executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        # –ü–∞—Ä–∞–º–µ—Ç—Ä script –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ action appleboy/ssh-action –∫–æ–º–∞–Ω–¥—ã,
        # –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ,
        # —Å –∫–æ—Ç–æ—Ä—ã–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        script: |
          cd /root/DZ_fastapi/infra/dev/
          # –í—ã–ø–æ–ª–Ω—è–µ—Ç pull –æ–±—Ä–∞–∑–æ–≤ —Å Docker Hub
          sudo docker compose -f docker-compose.dev.yaml pull
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ Docker Compose
          sudo docker compose -f docker-compose.dev.yaml build --no-cache
          sudo docker compose -f docker-compose.dev.yaml up -d --no-deps --build web
          # sudo docker compose -f docker-compose.dev.yaml down
          # sudo docker compose -f docker-compose.dev.yaml up -d
          # –í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–±–æ—Ä —Å—Ç–∞—Ç–∏–∫–∏
          sudo docker compose -f docker-compose.dev.yaml exec web poetry run alembic upgrade head

  send_success_message:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Send Telegram success message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!* üéâ"
          debug: true

  send_failure_message:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Send Telegram failure message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "‚ùå *–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!* ‚ö†Ô∏è"
          debug: true
